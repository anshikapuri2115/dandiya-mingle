<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dandiya Night Matchmaker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f7fafc;
        }
        .dancing-script {
            font-family: 'Dancing Script', cursive;
        }
        .gradient-background {
            background: linear-gradient(135deg, #f06b42, #f54291);
        }
        .container-bg {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .profile-card {
            background-color: #f7fafc;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f54291;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="gradient-background min-h-screen flex items-center justify-center p-4">

    <!-- Admin Login -->
    <div id="login-container" class="hidden container-bg w-full max-w-md text-center">
        <h1 class="dancing-script text-3xl font-bold text-gray-800 mb-4">Admin Login</h1>
        <input type="password" id="admin-password" class="form-input mb-4" placeholder="Enter Admin Password">
        <button id="login-button" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl hover:bg-pink-600 transition-colors">
            Log In
        </button>
        <p id="login-message" class="text-red-500 mt-4"></p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="container-bg w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Left Column: Form -->
        <div id="form-container">
            <div class="text-center mb-6">
                <h1 class="dancing-script text-5xl font-bold text-gray-800">Dandiya Night Matchmaker</h1>
                <p class="text-gray-600 mt-2">Find your perfect partner for a memorable night!</p>
            </div>

            <!-- Message Box and Spinner -->
            <div id="message-box" class="hidden text-center p-3 mb-4 rounded-xl text-sm font-medium"></div>
            <div id="loading-spinner" class="hidden loading-spinner mx-auto mb-4"></div>

            <div class="space-y-4">
                <p id="user-info" class="text-center text-sm text-gray-500"></p>

                <form id="profile-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="name" class="form-input" required>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" class="form-input" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                            <select id="gender" class="form-input" required>
                                <option value="" disabled selected>Select your gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
                            <input type="text" id="branch" class="form-input" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="rollNo" class="block text-sm font-medium text-gray-700">Roll No.</label>
                            <input type="text" id="rollNo" class="form-input" required>
                        </div>
                        <div>
                            <label for="collegeYear" class="block text-sm font-medium text-gray-700">Your College Year</label>
                            <select id="collegeYear" class="form-input" required>
                                <option value="" disabled selected>Select your year</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="interests" class="block text-sm font-medium text-gray-700">Interests (comma separated)</label>
                            <input type="text" id="interests" class="form-input">
                        </div>
                        <div>
                            <label for="hobbies" class="block text-sm font-medium text-gray-700">Hobbies (comma separated)</label>
                            <input type="text" id="hobbies" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="favoriteDandiyaSong" class="block text-sm font-medium text-gray-700">Favorite Dandiya Song/Artist</label>
                            <input type="text" id="favoriteDandiyaSong" class="form-input">
                        </div>
                        <div>
                            <label for="chaiOrCoffee" class="block text-sm font-medium text-gray-700">Chai or coffee?</label>
                            <select id="chaiOrCoffee" class="form-input" required>
                                <option value="" disabled selected>Select your answer</option>
                                <option value="Chai">Chai</option>
                                <option value="Coffee">Coffee</option>
                                <option value="Both">Both</option>
                                <option value="Neither">Neither</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="lateNightSnack" class="block text-sm font-medium text-gray-700">Your go-to late-night snack?</label>
                            <input type="text" id="lateNightSnack" class="form-input">
                        </div>
                        <div>
                            <label for="instagramHandle" class="block text-sm font-medium text-gray-700">Instagram Handle</label>
                            <input type="text" id="instagramHandle" class="form-input">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl hover:bg-pink-600 transition-colors">
                        Save My Profile
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Matches -->
        <div id="matches-container" class="space-y-4">
            <h2 id="matches-title" class="text-2xl font-bold text-gray-800 text-center mb-4">Matches Found</h2>
            <!-- Admin Matching Controls (Hidden by default) -->
            <div id="admin-controls" class="hidden">
                 <div class="space-y-2 mb-4">
                    <input type="text" id="admin-song-filter" class="form-input" placeholder="Filter by favorite song">
                    <button id="admin-filter-button" class="w-full bg-orange-500 text-white font-bold py-2 rounded-xl hover:bg-orange-600 transition-colors">
                        Find Matches
                    </button>
                </div>
            </div>
            <div id="matches-list" class="space-y-4">
                <p class="text-center text-gray-500">Submit your profile to see your matches here!</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        let app = null;
        let db = null;
        let auth = null;
        let userId;
        let currentUserProfile = null;

        // Admin password
        const ADMIN_PASSWORD = "dandiyanight"; // <--- CHANGE THIS PASSWORD

        // UI Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const profileForm = document.getElementById('profile-form');
        const matchesList = document.getElementById('matches-list');
        const messageBox = document.getElementById('message-box');
        const userInfoSpan = document.getElementById('user-info');
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginMessage = document.getElementById('login-message');
        const adminControls = document.getElementById('admin-controls');
        const matchesTitle = document.getElementById('matches-title');
        const adminFilterButton = document.getElementById('admin-filter-button');
        const adminSongFilterInput = document.getElementById('admin-song-filter');
        const formSubmitButton = profileForm.querySelector('button');
        const instagramHandleInput = document.getElementById('instagramHandle');
        const formFields = profileForm.querySelectorAll('input, select, button');

        // Helper functions
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} block`;
        }

        function toggleLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            formSubmitButton.disabled = isLoading;
            formSubmitButton.textContent = isLoading ? 'Saving...' : 'Save My Profile';
        }

        function renderMatches(profiles, isAdmin) {
            matchesList.innerHTML = '';
            const profilesToRender = isAdmin ? profiles : profiles.filter(p => p.userId !== userId);

            if (profilesToRender.length === 0) {
                matchesList.innerHTML = `<p class="text-center text-gray-500">${isAdmin ? 'No profiles match your filter.' : 'No matches found yet. Check back later!'}</p>`;
                return;
            }

            profilesToRender.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                let cardHtml = `
                    <p><strong>Name:</strong> ${profile.name}</p>
                    <p><strong>Branch:</strong> ${profile.branch}</p>
                    <p><strong>Roll No:</strong> ${profile.rollNo}</p>
                `;
                if (isAdmin) {
                    cardHtml += `
                        <p><strong>User ID:</strong> ${profile.userId}</p>
                        <p><strong>College Year:</strong> ${profile.collegeYear}</p>
                        <p><strong>Interests:</strong> ${profile.interests}</p>
                        <p><strong>Hobbies:</strong> ${profile.hobbies}</p>
                        <p><strong>Favorite Song:</strong> ${profile.favoriteDandiyaSong}</p>
                        <p><strong>Chai or Coffee:</strong> ${profile.chaiOrCoffee}</p>
                        <p><strong>Late Night Snack:</strong> ${profile.lateNightSnack}</p>
                        <p><strong>Email:</strong> ${profile.email || 'N/A'}</p>
                        <p><strong>Instagram Handle:</strong> ${profile.instagramHandle || 'N/A'}</p>
                    `;
                }
                profileCard.innerHTML = cardHtml;
                matchesList.appendChild(profileCard);
            });
        }

        // --- Main Application Logic ---
        
        const initializeAndAuth = async () => {
             // Handle cases where firebaseConfig might not be available
            if (!firebaseConfig) {
                showMessage("Firebase configuration is missing. Please check your settings.", "error");
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userInfoSpan.textContent = `Your User ID: ${userId}`;
                
                const urlParams = new URLSearchParams(window.location.search);
                const isAdminView = urlParams.get('admin') === 'true';

                if (isAdminView) {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    matchesTitle.textContent = "All Profiles";
                    adminControls.classList.remove('hidden');
                    matchesList.innerHTML = '<p class="text-center text-gray-500">Please log in to view profiles.</p>';

                    loginButton.addEventListener('click', () => {
                        if (adminPasswordInput.value === ADMIN_PASSWORD) {
                            loginContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            startAdminApp();
                        } else {
                            loginMessage.textContent = 'Incorrect password. Please try again.';
                        }
                    });
                } else {
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    startPublicApp();
                }

            } catch (error) {
                console.error("Authentication failed: ", error);
                showMessage("Authentication failed. Please check your Firebase settings.", "error");
            }
        };

        const startPublicApp = async () => {
            const userDocRef = doc(db, `/artifacts/${appId}/public/data/profiles`, userId);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                currentUserProfile = userDocSnap.data();
                document.getElementById('name').value = currentUserProfile.name || '';
                document.getElementById('email').value = currentUserProfile.email || '';
                document.getElementById('gender').value = currentUserProfile.gender || '';
                document.getElementById('branch').value = currentUserProfile.branch || '';
                document.getElementById('rollNo').value = currentUserProfile.rollNo || '';
                document.getElementById('collegeYear').value = currentUserProfile.collegeYear || '';
                document.getElementById('interests').value = currentUserProfile.interests || '';
                document.getElementById('hobbies').value = currentUserProfile.hobbies || '';
                document.getElementById('favoriteDandiyaSong').value = currentUserProfile.favoriteDandiyaSong || '';
                document.getElementById('chaiOrCoffee').value = currentUserProfile.chaiOrCoffee || '';
                document.getElementById('lateNightSnack').value = currentUserProfile.lateNightSnack || '';
                document.getElementById('instagramHandle').value = currentUserProfile.instagramHandle || '';

                // Disable the form as the profile already exists
                formFields.forEach(field => field.disabled = true);
                formSubmitButton.textContent = 'Profile Already Saved';
                formSubmitButton.disabled = true;
                showMessage("Your profile is already saved. You can now view your matches.", "success");

                startRealtimeMatchesListener(currentUserProfile.favoriteDandiyaSong, false);
            } else {
                console.log("No existing profile found. Create one!");
                matchesList.innerHTML = '<p class="text-center text-gray-500">Submit your profile to see your matches here!</p>';
            }
            
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) {
                    showMessage("Authentication failed. Please refresh the page.", "error");
                    return;
                }
                toggleLoading(true);
                const formData = {
                    userId: userId,
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    gender: document.getElementById('gender').value,
                    branch: document.getElementById('branch').value,
                    rollNo: document.getElementById('rollNo').value,
                    collegeYear: document.getElementById('collegeYear').value,
                    interests: document.getElementById('interests').value,
                    hobbies: document.getElementById('hobbies').value,
                    favoriteDandiyaSong: document.getElementById('favoriteDandiyaSong').value,
                    chaiOrCoffee: document.getElementById('chaiOrCoffee').value,
                    lateNightSnack: document.getElementById('lateNightSnack').value,
                    instagramHandle: document.getElementById('instagramHandle').value,
                    timestamp: new Date()
                };
                const docRef = doc(db, `/artifacts/${appId}/public/data/profiles`, userId);
                try {
                    await setDoc(docRef, formData);
                    showMessage("Profile saved successfully! Finding your matches...", "success");
                    toggleLoading(false);
                    currentUserProfile = formData;
                    startRealtimeMatchesListener(formData.favoriteDandiyaSong, false);
                    
                    // After saving, disable the form to prevent resubmission
                    formFields.forEach(field => field.disabled = true);
                    formSubmitButton.textContent = 'Profile Already Saved';
                    formSubmitButton.disabled = true;

                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("Error saving profile. Please try again.", "error");
                    toggleLoading(false);
                }
            });
        }

        const startAdminApp = async () => {
            const q = query(collection(db, `/artifacts/${appId}/public/data/profiles`));
            onSnapshot(q, (querySnapshot) => {
                const profiles = [];
                querySnapshot.forEach((doc) => {
                    profiles.push(doc.data());
                });
                renderMatches(profiles, true);
            });
            // Admin filter functionality
            adminFilterButton.addEventListener('click', () => {
                const filterSong = adminSongFilterInput.value.trim();
                if (filterSong) {
                    startRealtimeMatchesListener(filterSong, true);
                } else {
                    // If filter is empty, show all profiles again
                    const q = query(collection(db, `/artifacts/${appId}/public/data/profiles`));
                    onSnapshot(q, (querySnapshot) => {
                        const profiles = [];
                        querySnapshot.forEach((doc) => {
                            profiles.push(doc.data());
                        });
                        renderMatches(profiles, true);
                    });
                }
            });
        }

        // Real-time listener for matches
        function startRealtimeMatchesListener(song, isAdmin) {
            const q = query(collection(db, `/artifacts/${appId}/public/data/profiles`), where("favoriteDandiyaSong", "==", song));
            onSnapshot(q, (querySnapshot) => {
                const profiles = [];
                querySnapshot.forEach((doc) => {
                    profiles.push(doc.data());
                });
                renderMatches(profiles, isAdmin);
            });
        }
        
        initializeAndAuth();
    </script>
</body>
</html>

